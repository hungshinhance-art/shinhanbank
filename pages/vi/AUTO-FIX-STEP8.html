<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Fix Step8 Issues</title>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            margin: 0;
            font-size: 32px;
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .panel h2 {
            color: #333;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .issue {
            background: #f8f9fa;
            border-left: 4px solid #DC3545;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .issue.fixed {
            border-left-color: #28A745;
            background: #d4edda;
        }
        
        .issue h3 {
            margin: 0 0 10px 0;
            color: #DC3545;
            font-size: 16px;
        }
        
        .issue.fixed h3 {
            color: #28A745;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn.success {
            background: linear-gradient(135deg, #28A745 0%, #20C997 100%);
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #DC3545 0%, #C82333 100%);
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
        }
        
        .status-badge.ok {
            background: #28A745;
            color: white;
        }
        
        .status-badge.warn {
            background: #FFC107;
            color: black;
        }
        
        .status-badge.error {
            background: #DC3545;
            color: white;
        }
        
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        
        .log-entry.success { color: #28A745; }
        .log-entry.error { color: #DC3545; }
        .log-entry.warning { color: #FFC107; }
        .log-entry.info { color: #17A2B8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Auto-Fix Step8.html</h1>
            <p>T·ª± ƒë·ªông t√¨m v√† s·ª≠a t·∫•t c·∫£ l·ªói ti·ªÅm ·∫©n</p>
        </div>

        <div class="panel">
            <h2>üîç Scan for Issues</h2>
            <button class="btn" onclick="scanIssues()">
                üîé Qu√©t t√¨m l·ªói
            </button>
            <div id="issuesList"></div>
        </div>

        <div class="panel">
            <h2>üõ†Ô∏è Auto-Fix Actions</h2>
            <button class="btn success" onclick="autoFixAll()">
                ‚ú® T·ª± ƒë·ªông s·ª≠a T·∫§T C·∫¢
            </button>
            <button class="btn" onclick="createTestData()">
                üìù T·∫°o d·ªØ li·ªáu test
            </button>
            <button class="btn danger" onclick="resetAll()">
                üîÑ Reset v·ªÅ m·∫∑c ƒë·ªãnh
            </button>
        </div>

        <div class="panel">
            <h2>üìä Status</h2>
            <div id="statusDisplay"></div>
        </div>

        <div class="panel">
            <h2>üìù Action Log</h2>
            <div class="log" id="actionLog"></div>
        </div>

        <div class="panel">
            <h2>üöÄ Test</h2>
            <button class="btn success" onclick="window.open('/pages/vi/step8.html', '_blank')">
                ‚ñ∂Ô∏è M·ªü Step8 ƒë·ªÉ ki·ªÉm tra
            </button>
        </div>
    </div>

    <script>
        const log = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            log.push({ timestamp, message, type });
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logDiv = document.getElementById('actionLog');
            logDiv.innerHTML = log.map(entry => 
                `<div class="log-entry ${entry.type}">[${entry.timestamp}] ${entry.message}</div>`
            ).reverse().join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function scanIssues() {
            addLog('üîç B·∫Øt ƒë·∫ßu qu√©t t√¨m l·ªói...', 'info');
            const issues = [];
            
            // Check 1: userData exists?
            const userData = localStorage.getItem('userData');
            if (!userData) {
                issues.push({
                    type: 'error',
                    title: 'Thi·∫øu userData',
                    desc: 'Kh√¥ng t√¨m th·∫•y userData trong localStorage',
                    fix: 'T·∫°o d·ªØ li·ªáu m·∫´u'
                });
                addLog('‚ùå userData kh√¥ng t·ªìn t·∫°i', 'error');
            } else {
                addLog('‚úÖ userData t·ªìn t·∫°i', 'success');
                
                // Check 2: Can decrypt?
                try {
                    if (typeof CryptoJS !== 'undefined') {
                        const decrypted = CryptoJS.AES.decrypt(userData, 'shinhan-secret-key').toString(CryptoJS.enc.Utf8);
                        const data = JSON.parse(decrypted);
                        addLog('‚úÖ Decrypt th√†nh c√¥ng', 'success');
                        
                        // Check 3: Required fields?
                        const requiredFields = ['fullName', 'loanAmount', 'monthlyPayment'];
                        requiredFields.forEach(field => {
                            if (!data[field]) {
                                issues.push({
                                    type: 'warning',
                                    title: `Thi·∫øu field: ${field}`,
                                    desc: `userData.${field} kh√¥ng c√≥ gi√° tr·ªã`,
                                    fix: 'ƒêi·ªÅn l·∫°i form Step1'
                                });
                                addLog(`‚ö†Ô∏è Thi·∫øu ${field}`, 'warning');
                            } else {
                                addLog(`‚úÖ ${field} = ${data[field]}`, 'success');
                            }
                        });
                        
                        // Check 4: Data format
                        if (data.loanAmount && isNaN(parseInt(data.loanAmount))) {
                            issues.push({
                                type: 'error',
                                title: 'Format l·ªói: loanAmount',
                                desc: 'loanAmount kh√¥ng ph·∫£i l√† s·ªë',
                                fix: 'S·ª≠a format d·ªØ li·ªáu'
                            });
                            addLog('‚ùå loanAmount format l·ªói', 'error');
                        }
                        
                        if (data.monthlyPayment && isNaN(parseFloat(data.monthlyPayment))) {
                            issues.push({
                                type: 'error',
                                title: 'Format l·ªói: monthlyPayment',
                                desc: 'monthlyPayment kh√¥ng ph·∫£i l√† s·ªë',
                                fix: 'S·ª≠a format d·ªØ li·ªáu'
                            });
                            addLog('‚ùå monthlyPayment format l·ªói', 'error');
                        }
                        
                    } else {
                        issues.push({
                            type: 'error',
                            title: 'CryptoJS kh√¥ng load',
                            desc: 'Kh√¥ng th·ªÉ decrypt userData',
                            fix: 'Reload trang'
                        });
                        addLog('‚ùå CryptoJS ch∆∞a load', 'error');
                    }
                } catch (error) {
                    issues.push({
                        type: 'error',
                        title: 'L·ªói decrypt',
                        desc: error.message,
                        fix: 'X√≥a v√† t·∫°o l·∫°i userData'
                    });
                    addLog('‚ùå Decrypt error: ' + error.message, 'error');
                }
            }
            
            // Check 5: disbursementEndTime?
            const endTime = localStorage.getItem('disbursementEndTime');
            if (!endTime) {
                issues.push({
                    type: 'warning',
                    title: 'Thi·∫øu disbursementEndTime',
                    desc: 'Countdown timer s·∫Ω t·∫°o m·ªõi',
                    fix: 'Auto-create khi load'
                });
                addLog('‚ö†Ô∏è disbursementEndTime ch∆∞a c√≥', 'warning');
            } else {
                addLog('‚úÖ disbursementEndTime t·ªìn t·∫°i', 'success');
            }
            
            // Display issues
            const issuesDiv = document.getElementById('issuesList');
            if (issues.length === 0) {
                issuesDiv.innerHTML = `
                    <div class="issue fixed">
                        <h3>‚úÖ Kh√¥ng t√¨m th·∫•y l·ªói!</h3>
                        <p>Step8.html s·∫µn s√†ng ho·∫°t ƒë·ªông</p>
                    </div>
                `;
                addLog('‚úÖ Qu√©t ho√†n t·∫•t - Kh√¥ng c√≥ l·ªói!', 'success');
            } else {
                issuesDiv.innerHTML = issues.map(issue => `
                    <div class="issue">
                        <h3>${issue.type === 'error' ? '‚ùå' : '‚ö†Ô∏è'} ${issue.title}</h3>
                        <p><strong>M√¥ t·∫£:</strong> ${issue.desc}</p>
                        <p><strong>Gi·∫£i ph√°p:</strong> ${issue.fix}</p>
                    </div>
                `).join('');
                addLog(`‚ö†Ô∏è T√¨m th·∫•y ${issues.length} v·∫•n ƒë·ªÅ`, 'warning');
            }
            
            // Update status
            updateStatus();
        }
        
        function autoFixAll() {
            addLog('üîß B·∫Øt ƒë·∫ßu auto-fix...', 'info');
            
            // Fix 1: Create userData if missing
            let userData = localStorage.getItem('userData');
            if (!userData) {
                addLog('üìù T·∫°o userData m·∫´u...', 'info');
                createTestData();
                return; // createTestData will call autoFixAll again
            }
            
            // Fix 2: Ensure all required fields exist
            try {
                const decrypted = CryptoJS.AES.decrypt(userData, 'shinhan-secret-key').toString(CryptoJS.enc.Utf8);
                let data = JSON.parse(decrypted);
                
                let modified = false;
                
                // Fill missing fields with defaults
                if (!data.fullName) {
                    data.fullName = 'Nguy·ªÖn VƒÉn A';
                    modified = true;
                    addLog('üîß Th√™m fullName m·∫∑c ƒë·ªãnh', 'warning');
                }
                
                if (!data.loanAmount) {
                    data.loanAmount = '30000000';
                    modified = true;
                    addLog('üîß Th√™m loanAmount m·∫∑c ƒë·ªãnh', 'warning');
                }
                
                if (!data.monthlyPayment) {
                    // Calculate from loanAmount
                    const loanAmount = parseInt(data.loanAmount);
                    const term = parseInt(data.loanTerm) || 12;
                    const rate = (data.interestRate || 12) / 100 / 12;
                    data.monthlyPayment = (loanAmount * rate * Math.pow(1 + rate, term)) / (Math.pow(1 + rate, term) - 1);
                    modified = true;
                    addLog('üîß T√≠nh monthlyPayment t·ª´ loanAmount', 'warning');
                }
                
                if (modified) {
                    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), 'shinhan-secret-key').toString();
                    localStorage.setItem('userData', encrypted);
                    addLog('‚úÖ ƒê√£ c·∫≠p nh·∫≠t userData', 'success');
                }
                
            } catch (error) {
                addLog('‚ùå L·ªói fix userData: ' + error.message, 'error');
                return;
            }
            
            // Fix 3: Create disbursementEndTime if missing
            if (!localStorage.getItem('disbursementEndTime')) {
                const endTime = Date.now() + (24 * 60 * 60 * 1000);
                localStorage.setItem('disbursementEndTime', endTime.toString());
                addLog('‚úÖ T·∫°o disbursementEndTime (24h countdown)', 'success');
            }
            
            addLog('‚úÖ AUTO-FIX HO√ÄN T·∫§T!', 'success');
            updateStatus();
            
            setTimeout(() => {
                scanIssues();
            }, 500);
        }
        
        function createTestData() {
            addLog('üìù T·∫°o d·ªØ li·ªáu test ho√†n ch·ªânh...', 'info');
            
            const userData = {
                fullName: 'Nguy·ªÖn VƒÉn Test',
                dob: '01/01/1990',
                gender: 'Nam',
                contactAddress: '123 ƒê∆∞·ªùng Test, Qu·∫≠n 1, TP.HCM',
                cccd: '123456789012',
                issuePlace: 'C·ª•c C·∫£nh s√°t ƒêKQL C∆∞ tr√∫ v√† DLQG v·ªÅ d√¢n c∆∞',
                phone: '0901234567',
                email: 'test@example.com',
                loanType: 'Vay t√≠n ch·∫•p',
                loanTerm: '12',
                loanAmount: '50000000',
                interestRate: 12.0,
                monthlyIncome: 15000000,
                occupation: 'K·ªπ s∆∞',
                purpose: 'business',
                accountName: 'Nguy·ªÖn VƒÉn Test',
                accountNumber: '1234567890',
                bankName: 'shinhan',
                loanCode: 'SHB' + Math.floor(100000 + Math.random() * 900000),
                monthlyPayment: 4441.67,
                totalInterest: 3300000,
                totalRepay: 53300000,
                currentStep: 8,
                isRegistered: true,
                emailSent: true,
                timestamp: new Date().toISOString()
            };
            
            try {
                const encryptedData = CryptoJS.AES.encrypt(JSON.stringify(userData), 'shinhan-secret-key').toString();
                localStorage.setItem('userData', encryptedData);
                
                const endTime = Date.now() + (24 * 60 * 60 * 1000);
                localStorage.setItem('disbursementEndTime', endTime.toString());
                
                addLog('‚úÖ T·∫°o userData th√†nh c√¥ng', 'success');
                addLog('‚úÖ T·∫°o disbursementEndTime th√†nh c√¥ng', 'success');
                addLog('üìä Data: ' + userData.fullName + ', ' + userData.loanAmount, 'info');
                
                updateStatus();
                scanIssues();
            } catch (error) {
                addLog('‚ùå L·ªói t·∫°o data: ' + error.message, 'error');
            }
        }
        
        function resetAll() {
            if (confirm('‚ö†Ô∏è X√≥a T·∫§T C·∫¢ d·ªØ li·ªáu?\n\nStep8 s·∫Ω hi·ªÉn th·ªã d·ªØ li·ªáu m·∫∑c ƒë·ªãnh.')) {
                localStorage.removeItem('userData');
                localStorage.removeItem('disbursementEndTime');
                addLog('üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ localStorage', 'warning');
                updateStatus();
                scanIssues();
            }
        }
        
        function updateStatus() {
            const statusDiv = document.getElementById('statusDisplay');
            const hasUserData = !!localStorage.getItem('userData');
            const hasEndTime = !!localStorage.getItem('disbursementEndTime');
            
            let html = '<div style="display: flex; gap: 10px; flex-wrap: wrap;">';
            
            html += hasUserData ? 
                '<span class="status-badge ok">‚úÖ userData OK</span>' : 
                '<span class="status-badge error">‚ùå userData THI·∫æU</span>';
            
            html += hasEndTime ? 
                '<span class="status-badge ok">‚úÖ Timeline OK</span>' : 
                '<span class="status-badge warn">‚ö†Ô∏è Timeline s·∫Ω t·∫°o m·ªõi</span>';
            
            html += '</div>';
            
            // Show current data preview
            if (hasUserData) {
                try {
                    const encrypted = localStorage.getItem('userData');
                    const decrypted = CryptoJS.AES.decrypt(encrypted, 'shinhan-secret-key').toString(CryptoJS.enc.Utf8);
                    const data = JSON.parse(decrypted);
                    
                    html += `
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0;">üìä D·ªØ li·ªáu hi·ªán t·∫°i:</h4>
                            <p><strong>H·ªç t√™n:</strong> ${data.fullName || 'N/A'}</p>
                            <p><strong>S·ªë ti·ªÅn vay:</strong> ${data.loanAmount ? parseInt(data.loanAmount).toLocaleString('vi-VN') + ' ƒë' : 'N/A'}</p>
                            <p><strong>Tr·∫£ h√†ng th√°ng:</strong> ${data.monthlyPayment ? Math.floor(data.monthlyPayment).toLocaleString('vi-VN') + ' ƒë' : 'N/A'}</p>
                        </div>
                    `;
                } catch (error) {
                    html += `<div style="margin-top: 15px; padding: 15px; background: #f8d7da; border-radius: 8px;">
                        <p style="color: #DC3545;"><strong>‚ùå L·ªói ƒë·ªçc d·ªØ li·ªáu:</strong> ${error.message}</p>
                    </div>`;
                }
            }
            
            statusDiv.innerHTML = html;
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            addLog('üöÄ Auto-Fix Tool initialized', 'success');
            updateStatus();
        });
    </script>
</body>
</html>

