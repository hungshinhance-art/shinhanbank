<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Step8 Data Loading</title>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <style>
      body {
        font-family: "Courier New", monospace;
        padding: 20px;
        background: #1e1e1e;
        color: #d4d4d4;
      }

      .debug-panel {
        background: #2d2d2d;
        border: 2px solid #0088ff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .debug-panel h2 {
        color: #0088ff;
        margin-top: 0;
      }

      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-weight: bold;
      }

      .success {
        background: #28a745;
        color: white;
      }

      .error {
        background: #dc3545;
        color: white;
      }

      .warning {
        background: #ffc107;
        color: black;
      }

      .data-field {
        background: #1e1e1e;
        padding: 10px;
        border-left: 3px solid #0088ff;
        margin: 5px 0;
      }

      .data-field label {
        color: #808080;
        font-size: 12px;
      }

      .data-field .value {
        color: #4ec9b0;
        font-size: 16px;
        font-weight: bold;
      }

      .btn {
        background: #0088ff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-weight: bold;
      }

      .btn:hover {
        background: #0068cc;
      }

      .btn.danger {
        background: #dc3545;
      }

      pre {
        background: #1e1e1e;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        color: #ce9178;
      }
    </style>
  </head>
  <body>
    <div class="debug-panel">
      <h2>üîç STEP8 DATA LOADING DEBUG</h2>

      <div id="status"></div>

      <button class="btn" onclick="checkData()">üîÑ Ki·ªÉm tra userData</button>
      <button class="btn" onclick="fixData()">üîß Fix & Reload</button>
      <button class="btn danger" onclick="clearData()">
        üóëÔ∏è Clear userData
      </button>
      <button
        class="btn"
        onclick="window.open('/pages/vi/step8.html', '_blank')"
      >
        ‚ñ∂Ô∏è M·ªü Step8
      </button>
    </div>

    <div class="debug-panel">
      <h2>üìä localStorage Status</h2>
      <div id="localStorageStatus"></div>
    </div>

    <div class="debug-panel">
      <h2>üìã userData Fields</h2>
      <div id="userDataFields"></div>
    </div>

    <div class="debug-panel">
      <h2>üíæ Raw Data</h2>
      <pre id="rawData"></pre>
    </div>

    <script>
      function checkData() {
        const statusDiv = document.getElementById("status");
        const lsStatus = document.getElementById("localStorageStatus");
        const fieldsDiv = document.getElementById("userDataFields");
        const rawDiv = document.getElementById("rawData");

        // Check if userData exists
        const encryptedData = localStorage.getItem("userData");

        if (!encryptedData) {
          statusDiv.innerHTML =
            '<div class="status error">‚ùå KH√îNG T√åM TH·∫§Y userData trong localStorage</div>';
          lsStatus.innerHTML =
            '<p>localStorage.getItem("userData") = <strong>null</strong></p>';
          fieldsDiv.innerHTML = "<p>Kh√¥ng c√≥ d·ªØ li·ªáu</p>";
          rawDiv.textContent = "No data";
          return;
        }

        statusDiv.innerHTML =
          '<div class="status success">‚úÖ userData T·ªíN T·∫†I trong localStorage</div>';

        // Try to decrypt
        let userData;
        let decryptMethod = "";

        try {
          if (typeof CryptoJS === "undefined") {
            decryptMethod = "Plain JSON (CryptoJS not loaded)";
            userData = JSON.parse(encryptedData);
          } else {
            decryptMethod = "CryptoJS AES Decryption";
            const decryptedData = CryptoJS.AES.decrypt(
              encryptedData,
              "shinhan-secret-key"
            ).toString(CryptoJS.enc.Utf8);
            userData = JSON.parse(decryptedData);
          }

          statusDiv.innerHTML +=
            '<div class="status success">‚úÖ DECRYPT TH√ÄNH C√îNG - Method: ' +
            decryptMethod +
            "</div>";
        } catch (error) {
          statusDiv.innerHTML +=
            '<div class="status error">‚ùå DECRYPT L·ªñI: ' +
            error.message +
            "</div>";
          rawDiv.textContent = "Decrypt failed: " + error.message;
          return;
        }

        // Show localStorage status
        lsStatus.innerHTML = `
                <p>‚úÖ localStorage.getItem("userData") = <strong>EXISTS</strong></p>
                <p>üìè Data length: <strong>${encryptedData.length}</strong> characters</p>
                <p>üîê Decryption: <strong>${decryptMethod}</strong></p>
            `;

        // Show fields
        const fields = [
          { key: "fullName", label: "üë§ H·ªç v√† t√™n", target: "customerName" },
          {
            key: "loanAmount",
            label: "üí∞ S·ªë ti·ªÅn vay",
            target: "loanAmountValue",
          },
          {
            key: "monthlyPayment",
            label: "üíµ Tr·∫£ h√†ng th√°ng",
            target: "monthlyPaymentAmount",
          },
          { key: "cccd", label: "üÜî CCCD", target: null },
          { key: "phone", label: "üìû ƒêi·ªán tho·∫°i", target: null },
          { key: "email", label: "üìß Email", target: null },
          { key: "loanTerm", label: "üìÖ K·ª≥ h·∫°n", target: null },
          { key: "loanType", label: "üìã Lo·∫°i vay", target: null },
        ];

        let fieldsHTML = "";
        fields.forEach((field) => {
          const value = userData[field.key];
          const status = value ? "‚úÖ" : "‚ùå";
          const displayValue = value || "N/A";

          fieldsHTML += `
                    <div class="data-field">
                        <label>${status} ${field.label}</label>
                        <div class="value">${displayValue}</div>
                        ${
                          field.target
                            ? `<small>‚Üí Maps to: <code>#${field.target}</code></small>`
                            : ""
                        }
                    </div>
                `;
        });

        fieldsDiv.innerHTML = fieldsHTML;

        // Show raw data
        rawDiv.textContent = JSON.stringify(userData, null, 2);

        // Verify element IDs exist in DOM
        console.log("üîç Checking if elements exist in step8.html:");
        const elements = [
          "customerName",
          "loanAmountValue",
          "monthlyPaymentAmount",
          "requiredAmount",
          "paymentDate",
        ];
        elements.forEach((id) => {
          const exists = document.getElementById(id) !== null;
          console.log(`  ${exists ? "‚úÖ" : "‚ùå"} #${id}`);
        });
      }

      function fixData() {
        const userData = {
          fullName: "Nguy·ªÖn VƒÉn Test",
          dob: "01/01/1990",
          gender: "Nam",
          contactAddress: "123 ƒê∆∞·ªùng Test, Qu·∫≠n 1, TP.HCM",
          cccd: "123456789012",
          issuePlace: "C·ª•c C·∫£nh s√°t ƒêKQL C∆∞ tr√∫ v√† DLQG v·ªÅ d√¢n c∆∞",
          phone: "0901234567",
          email: "test@example.com",
          loanType: "Vay t√≠n ch·∫•p",
          loanTerm: "12",
          loanAmount: "50000000",
          interestRate: 12.0,
          monthlyIncome: 15000000,
          occupation: "K·ªπ s∆∞",
          purpose: "business",
          accountName: "Nguy·ªÖn VƒÉn Test",
          accountNumber: "1234567890",
          bankName: "shinhan",
          loanCode: "SHB" + Math.floor(100000 + Math.random() * 900000),
          monthlyPayment: 4441.67,
          totalInterest: 3300000,
          totalRepay: 53300000,
          currentStep: 8,
          isRegistered: true,
          emailSent: true,
          timestamp: new Date().toISOString(),
        };

        try {
          const encryptedData = CryptoJS.AES.encrypt(
            JSON.stringify(userData),
            "shinhan-secret-key"
          ).toString();
          localStorage.setItem("userData", encryptedData);
          alert(
            '‚úÖ ƒê√£ t·∫°o userData m·∫´u!\n\nClick "Ki·ªÉm tra userData" ƒë·ªÉ verify'
          );
          checkData();
        } catch (error) {
          alert("‚ùå L·ªói: " + error.message);
        }
      }

      function clearData() {
        if (confirm("X√≥a userData?")) {
          localStorage.removeItem("userData");
          alert("‚úÖ ƒê√£ x√≥a userData!");
          checkData();
        }
      }

      // Auto check on load
      window.addEventListener("DOMContentLoaded", checkData);
    </script>
  </body>
</html>
